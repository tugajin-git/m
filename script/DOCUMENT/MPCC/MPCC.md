# 車両モデルの概要

本ドキュメントでは、RC（ラジコン）カーの動力学モデルについて説明する。特に、動的Bicycle Kinematic Modelとペースジャッカのマジックフォーミュラを用いたタイヤ力の非線形モデル化に焦点を当てている。これにより、高速走行時やハンドリング限界におけるリアリスティックな車両挙動を実現する。

##  車両モデル

### A. Bicycle Kinematic Model

RCカーは、Bicycle Kinematic Modelを用いて以下のようにモデル化される。このモデルは、車両を質量 \( m \) と慣性モーメント \( I_z \) を持つ単一の剛体として扱い、車両の対称性を利用してBicycle Kinematic Modelに簡略化している。

- **前提条件:**
  1. 車両は平坦な表面上を走行する。
  2. 荷重移動は無視できる。
  3. 結合スリップ(Combined Slip)は無視できる。
  4. 縦方向の駆動力は重心に作用する。

- **考慮する運動:**
  - へいめんのみ（ピッチとロールの動力学および荷重変化は無視）
  - リアホイール駆動でアクティブブレーキなしのため、前輪の縦方向力は無視

- **状態変数:**
  - **位置:** \( X, Y \) （慣性フレームにおける重心の位置）
  - **姿勢角:** \( \phi \) （慣性フレームに対する車両の角度）
  - **速度:** \( v_x, v_y \) （長手方向および横方向の速度）
  - **ヨー角速度:** \( \omega \)

- **制御入力:**
  - **ステアリング角:** \( \delta \)
  - **駆動コマンド:** \( D \) （PWMデューティサイクル、\( D = 1 \) は全開アクセル、\( D = -1 \) は全ブレーキ）

#### モデルの運動方程式

以下に、車両の運動方程式を示す。

\[
\begin{align}
\dot{X} &= v_x \cos(\phi) - v_y \sin(\phi) \quad (1a) \\
\dot{Y} &= v_x \sin(\phi) + v_y \cos(\phi) \quad (1b) \\
\dot{\phi} &= \omega \quad (1c) \\
\dot{v}_x &= \frac{1}{m} \left(F_{R,x} - F_{F,y} \sin \delta + m v_y \omega\right) \quad (1d) \\
\dot{v}_y &= \frac{1}{m} \left(F_{R,y} + F_{F,y} \cos \delta - m v_x \omega\right) \quad (1e) \\
\dot{\omega} &= \frac{1}{I_z} \left(F_{F,y} l_F \cos \delta - F_{R,y} l_R + \tau_{TV}\right) \quad (1f)
\end{align}
\]

- **各変数の説明:**
  - \( m \): 車両の質量
  - \( I_z \): ヨー慣性モーメント
  - \( l_F, l_R \): 重心から前後ホイールまでの距離
  - \( F_{R,y}, F_{F,y} \): リアおよびフロントホイールの横方向タイヤ力
  - \( F_{R,x} \): リアホイールの縦方向力
  - \( \phi \): ヘディング角（ヨー角）
  - \( v_x, v_y \): 長手方向および横方向の速度
  - \( \omega \): ヨー角速度
  - \( \delta \): ステアリング角

#### タイヤ力のモデル化

タイヤ力 \( F_{a,y} \) は、車両と路面との相互作用を表し、ここで \( a \) は前輪（F）または後輪（R）を示す。タイヤ力はペースジャッカの簡略化されたタイヤモデルを用いて以下のように表現される。

\[
\begin{align}
F_{F,y} &= D_F \sin\left(C_F \arctan(B_F \alpha_F)\right) \quad (2a) \\
F_{R,y} &= D_R \sin\left(C_R \arctan(B_R \alpha_R)\right) \quad (2b) \\
F_{R,x} &= (C_{m1} - C_{m2} v_x) d - C_r - C_d v_x^2 \quad (2c)
\end{align}
\]

- **スリップ角の定義:**

\[
\begin{align}
\alpha_R &= \arctan\left(\frac{v_y - l_R \omega}{v_x}\right) \\
\alpha_F &= \arctan\left(\frac{v_y + l_F \omega}{v_x}\right) - \delta \quad (6)
\end{align}
\]

- **各パラメータの説明:**
  - \( B_a, C_a, D_a \) （\( a \in \{R, F\} \)）: モデルの実験的に識別された係数
  - \( \alpha_a \) （\( a \in \{R, F\} \)）: リアおよびフロントのスリップ角

#### 駆動力モデル

縦方向タイヤ力 \( F_{R,x} \) は、駆動系モデルにより以下のように表現される。

\[
F_{R,x} = C_{m1} d - C_{m2} v_x d - C_r - C_d v_x^2 \quad (2c)
\]

- **パラメータの説明:**
  - \( C_{m1}, C_{m2} \): モーターの特性を表す係数
  - \( C_r \): 転がり抵抗
  - \( C_d \): 空気抵抗（ドラッグ）の係数
  - \( v_x \): 車両の長手方向速度
  - \( d \): PWMデューティサイクル（制御入力）

#### トルクベクタリングモーメント \( \tau_{TV} \)

低レベルコントローラーが要求された力を4つのモーターに独立して分配することにより生成されるトルクベクタリングモーメント \( \tau_{TV} \) は、以下のように定義される。

\[
\begin{align}
r_{target} &= \frac{\delta v_x}{l_F + l_R} \quad (8) \\
\tau_{TV} &= (r_{target} - \omega) P_{TV} \quad (9)
\end{align}
\]

- **パラメータの説明:**
  - \( P_{TV} \): 低レベルトルクベクタリングコントローラーの比例ゲイン
  - \( \omega \): ヨー角速度

### 加速度の制約条件の設定

車両の安定性と安全性を確保するために、加速度に対する制約条件を設定する。これには、タイヤグリップに基づく制約やフリクションサークルを用いた制約が含まれる。

#### タイヤグリップに基づく制約

- **縦方向加速度 \( a_x \) の制約:**

\[
a_x = \frac{F_{R,x}}{m}
\]
\[
|a_x| \leq \frac{D_R}{m}
\]

- **横方向加速度 \( a_y \) の制約:**

\[
a_y = \frac{F_{F,y} + F_{R,y}}{m}
\]
\[
|a_y| \leq \frac{D_F + D_R}{m}
\]

#### フリクションサークルによる制約

フリクションサークルの概念を用いて、縦方向および横方向の力の合計がタイヤの摩擦限界を超えないように制約する。

\[
\left( \frac{F_{F,y}}{D_F} \right)^2 + \left( \frac{F_{R,y}}{D_R} \right)^2 \leq 1
\]

これを加速度に置き換えると以下のようになる。

\[
\left( \frac{a_{y,F}}{a_{y,\text{max},F}} \right)^2 + \left( \frac{a_{y,R}}{a_{y,\text{max},R}} \right)^2 \leq 1
\]

ここで、

\[
a_{y,\text{max},F} = \frac{D_F}{m}, \quad a_{y,\text{max},R} = \frac{D_R}{m}
\]

### 制約条件の具体的な設定方法

#### 最適化問題における制約設定

車両の制御問題を最適化問題として定式化する際に、加速度の制約条件を以下のように設定する。

\[
\begin{align*}
a_x^{\min} \leq a_x \leq a_x^{\max} \\
a_y^{\min} \leq a_y \leq a_y^{\max}
\end{align*}
\]

これらの制約は、車両がハンドリング限界を超えないようにするために設定される。具体的な例として、

\[
\begin{align*}
-5 \, \text{m/s}^2 \leq a_x \leq 5 \, \text{m/s}^2 \\
-3 \, \text{m/s}^2 \leq a_y \leq 3 \, \text{m/s}^2
\end{align*}
\]

と設定することが考えられる。これらの値は車両の性能やタイヤの特性に応じて調整される。

#### リアルタイム制御での制約適用

リアルタイム制御アルゴリズム（例: モデル予測制御）では、各制御ステップで以下のような制約を適用する。

1. **速度制約:** 車両の最大速度や最低速度を設定する。
2. **加速度制約:** 縦方向および横方向の加速度制約を適用する。
3. **ヨー角速度制約:** 車両の旋回能力を超えないようにヨー角速度に制約を設定する。

### パラメータの調整とチューニング

加速度の制約条件は、車両の特性や使用条件に応じて調整される。以下の方法でパラメータをチューニングする。

1. **実験データの収集:**
   - 実際の車両を用いて加速度データを収集し、タイヤのグリップ限界や車両の動的特性を把握する。

2. **シミュレーションによる検証:**
   - 収集したデータを基にシミュレーションを行い、制約条件が適切かどうかを検証する。
   - 必要に応じて制約パラメータを調整する。

3. **フィードバックループの構築:**
   - 実運用中に得られるデータを用いて、制約条件を動的に調整するフィードバックループを構築する。

---
